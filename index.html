<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecionando para o WhatsApp...</title>

  <!-- ✅ Google tag (gtag.js) - AW correto -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17876134901"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    // ✅ Configuração principal da Tag do Google Ads
    gtag('config', 'AW-17876134901');
  </script>

  <style>
    body{
      font-family: Arial, sans-serif;
      text-align:center;
      padding: 80px 16px;
      background:#ffffff;
      color:#2b2b2b;
    }
    h1{
      font-size: 28px;
      margin-bottom: 10px;
      color:#1f7a1f;
    }
    p{
      font-size: 16px;
      margin-top: 0;
    }
    .small{
      margin-top: 20px;
      font-size: 13px;
      color:#666;
      word-break: break-all;
      max-width: 900px;
      margin-left:auto;
      margin-right:auto;
    }
  </style>
</head>

<body>
  <h1>Você está sendo direcionado para o WhatsApp do grameiro.</h1>
  <p>Por favor, aguarde alguns segundos...</p>

  <p class="small" id="debug"></p>

  <script>
    // ============================================================
    // ✅ CONFIGURAÇÕES (altere apenas se necessário)
    // ============================================================

    // ✅ Número do WhatsApp com DDI + DDD (sem + e sem espaços)
    // (ajuste se seu número for outro)
    const WHATSAPP_PHONE = "553798332874";

    // ✅ Mensagem padrão
    const WHATSAPP_TEXT = "Olá gostaria de um orçamento de grama.";

    // ✅ ID da conversão (send_to) - já correto
    const SEND_TO = "AW-17876134901/kEX7COuHweMbEPXXgMxC";

    // Tempo de espera para disparar o evento antes do redirect
    const REDIRECT_DELAY_MS = 900;

    // ============================================================
    // ✅ FUNÇÕES AUXILIARES
    // ============================================================

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function getFirstNonEmpty(...values){
      for (const v of values){
        if (v !== null && v !== undefined && String(v).trim() !== "") return String(v).trim();
      }
      return null;
    }

    function buildWhatsAppUrl(phone, text){
      const encodedText = encodeURIComponent(text);
      return `https://wa.me/${phone}?text=${encodedText}`;
    }

    function appendParams(url, paramsObj) {
      const u = new URL(url);
      for (const [k, v] of Object.entries(paramsObj)) {
        if (v !== null && v !== undefined && String(v).trim() !== "") {
          u.searchParams.set(k, v);
        }
      }
      return u.toString();
    }

    // ============================================================
    // ✅ 1) CAPTURAR GCLID / WBRAID / GBRAID
    // ============================================================

    // Pegando da URL atual do GitHub pages:
    const url_gclid  = getQueryParam("gclid");
    const url_wbraid = getQueryParam("wbraid");
    const url_gbraid = getQueryParam("gbraid");

    // Pegando do localStorage (se já passou por aqui antes)
    const ls_gclid  = localStorage.getItem("gclid");
    const ls_wbraid = localStorage.getItem("wbraid");
    const ls_gbraid = localStorage.getItem("gbraid");

    // Prioridade: URL -> localStorage
    const gclid  = getFirstNonEmpty(url_gclid,  ls_gclid);
    const wbraid = getFirstNonEmpty(url_wbraid, ls_wbraid);
    const gbraid = getFirstNonEmpty(url_gbraid, ls_gbraid);

    // Salva para não perder numa próxima visita
    if (gclid)  localStorage.setItem("gclid", gclid);
    if (wbraid) localStorage.setItem("wbraid", wbraid);
    if (gbraid) localStorage.setItem("gbraid", gbraid);

    // Debug opcional na tela
    document.getElementById("debug").innerText =
      `Rastreio: gclid=${gclid || "-"} | wbraid=${wbraid || "-"} | gbraid=${gbraid || "-"}`;

    // ============================================================
    // ✅ 2) DISPARAR CONVERSÃO GOOGLE ADS (send_to correto)
    // ============================================================

    // IMPORTANTÍSSIMO: forçar gclid na tag quando existir
    // (ajuda na atribuição quando você não tem tag no Carrd)
    if (gclid) {
      gtag('set', 'url_passthrough', true);
      gtag('set', 'ads_data_redaction', false);

      // associa gclid ao evento
      gtag('set', { 'gclid': gclid });
    }

    gtag('event', 'conversion', {
      'send_to': SEND_TO
    });

    // ============================================================
    // ✅ 3) REDIRECIONAR PARA WHATSAPP
    // ============================================================

    // Opção: anexar gclid no texto do WhatsApp (recomendado)
    // Assim, mesmo que a medição falhe, você consegue rastrear manualmente.
    let finalText = WHATSAPP_TEXT;

    if (gclid)  finalText += `\n\nID anúncio (gclid): ${gclid}`;
    if (wbraid) finalText += `\n(wbraid): ${wbraid}`;
    if (gbraid) finalText += `\n(gbraid): ${gbraid}`;

    let whatsappUrl = buildWhatsAppUrl(WHATSAPP_PHONE, finalText);

    // (extra) se quiser manter os parâmetros na URL do WhatsApp também:
    // whatsappUrl = appendParams(whatsappUrl, { gclid, wbraid, gbraid });

    setTimeout(function(){
      window.location.href = whatsappUrl;
    }, REDIRECT_DELAY_MS);

  </script>
</body>
</html>

